# End-to-End Job Flow

## Overview

This document describes the steady-state flow of a job from submission through completion, highlighting **routing**, **state transitions**, and **exactly-once delivery semantics**.

Failure handling, retries, and edge cases are covered in later sections.

---

## Job Flow Diagram

```
1. Researcher submits job â†’ Ingress
2. Ingress validates request
   - Assigns job_id (UUID)
   - Writes initial state to PostgreSQL (PENDING)
3. Ingress publishes job metadata to global intake queue
4. Master Scheduler consumes intake message
   - Evaluates requirements (GPU, CPU, memory)
   - Selects target shard
   - Updates state to SCHEDULED
5. Master writes job to shard-specific queue
6. Master ACKs intake message
   - Exactly-once delivery at shard boundary
7. Shard Scheduler consumes shard queue
   - Selects worker
   - Updates state to RUNNING
8. Worker executes job in isolated namespace + cgroup
9. Worker publishes result to callback_address
   - Updates state to COMPLETED or FAILED
10. Ingress notifies researcher
```

### Key Properties

- **Admission is decoupled from execution**  
  Ingress never communicates directly with workers.

- **Exactly-once routing at shard boundary**  
  Intake messages are ACKed only after successful shard enqueue.

- **Durable state, transient transport**  
  PostgreSQL tracks job state; message queues handle delivery.

- **No central results bottleneck**  
  Results are routed directly to ingress-specific callback addresses.

---

## State Transitions (PostgreSQL)

| State | Meaning | Updated By |
|------|--------|------------|
| PENDING | Job validated, awaiting scheduling | Ingress |
| SCHEDULED | Assigned to shard | Master Scheduler |
| RUNNING | Executing on worker | Shard Scheduler |
| COMPLETED | Finished successfully | Worker |
| FAILED | Execution error | Worker |

---

## Separation of Concerns

- **Message Queues**: job routing, retries, delivery guarantees  
- **PostgreSQL**: durable job state, history, auditability  
- **Control Plane (DDS)**: scheduler coordination and capacity signals only

Job payloads are stored in object storage and referenced by URI to keep queue messages small.
